---
title: Docker å®¹å™¨åŒ–éƒ¨ç½²æŒ‡å—
description: å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–ã€Docker Composeç¼–æ’ã€Nginxé…ç½®ã€ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æœ€ä½³å®è·µ
date: 2025-10-14
category: devops
tags: [Docker, Docker Compose, Nginx, éƒ¨ç½², DevOps]
author: Tech Showcase
---

# Docker å®¹å™¨åŒ–éƒ¨ç½²æŒ‡å—

ä½¿ç”¨ Docker å’Œ Docker Compose å®ç°åº”ç”¨çš„å®¹å™¨åŒ–éƒ¨ç½²ï¼Œæå‡å¼€å‘æ•ˆç‡å’Œéƒ¨ç½²ä¸€è‡´æ€§ã€‚

## Docker åŸºç¡€

### 1. Dockerfile æœ€ä½³å®è·µ

#### å¤šé˜¶æ®µæ„å»ºï¼ˆGo åç«¯ï¼‰

```dockerfile
# é˜¶æ®µ1: æ„å»º
FROM golang:1.22-alpine AS builder

WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY go.mod go.sum ./
RUN go mod download

# å¤åˆ¶æºä»£ç 
COPY . .

# ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main cmd/main.go

# é˜¶æ®µ2: è¿è¡Œ
FROM alpine:latest

RUN apk --no-cache add ca-certificates

WORKDIR /root/

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
COPY --from=builder /app/main .

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¯åŠ¨åº”ç”¨
CMD ["./main"]
```

#### å¤šé˜¶æ®µæ„å»ºï¼ˆNext.js å‰ç«¯ï¼‰

```dockerfile
# é˜¶æ®µ1: ä¾èµ–å®‰è£…
FROM node:20-alpine AS deps

WORKDIR /app

COPY package.json package-lock.json ./
RUN npm ci

# é˜¶æ®µ2: æ„å»º
FROM node:20-alpine AS builder

WORKDIR /app

COPY --from=deps /app/node_modules ./node_modules
COPY . .

RUN npm run build

# é˜¶æ®µ3: è¿è¡Œ
FROM node:20-alpine AS runner

WORKDIR /app

ENV NODE_ENV production

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# å¤åˆ¶å¿…è¦æ–‡ä»¶
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000

CMD ["node", "server.js"]
```

### 2. .dockerignore æ–‡ä»¶

```
# å‰ç«¯
node_modules
.next
.git
.env.local
npm-debug.log*

# åç«¯
vendor
*.exe
*.test
.env
```

## Docker Compose ç¼–æ’

### å®Œæ•´çš„ docker-compose.yml

```yaml
version: '3.8'

services:
  # MySQL æ•°æ®åº“
  db:
    image: mysql:8.0
    container_name: app-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - "3307:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # phpMyAdmin - æ•°æ®åº“ç®¡ç†
  phpmyadmin:
    image: phpmyadmin/phpmyadmin:5.2
    container_name: app-phpmyadmin
    restart: unless-stopped
    environment:
      PMA_HOST: db
      PMA_PORT: 3306
      PMA_USER: ${DB_USER}
      PMA_PASSWORD: ${DB_PASSWORD}
    ports:
      - "8081:80"
    depends_on:
      - db
    networks:
      - app-network

  # Go åç«¯æœåŠ¡
  backend:
    build:
      context: ./backend-go
      dockerfile: Dockerfile
    image: app-backend:latest
    container_name: app-backend
    restart: unless-stopped
    environment:
      - DB_HOST=db
      - DB_PORT=3306
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - SERVER_PORT=8080
      - JWT_SECRET=${JWT_SECRET}
      - GIN_MODE=release
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8080:8080"
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Next.js å‰ç«¯æœåŠ¡
  frontend:
    build:
      context: ./frontend-nextjs
      dockerfile: Dockerfile
    image: app-frontend:latest
    container_name: app-frontend
    restart: unless-stopped
    environment:
      - NEXT_PUBLIC_API_URL=http://backend:8080
      - NODE_ENV=production
    depends_on:
      - backend
    ports:
      - "3000:3000"
    networks:
      - app-network

  # Nginx åå‘ä»£ç†
  nginx:
    image: nginx:1.25-alpine
    container_name: app-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
      - backend
    networks:
      - app-network

volumes:
  mysql-data:
    driver: local

networks:
  app-network:
    driver: bridge
```

## Nginx é…ç½®

### nginx.conf

```nginx
events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss;

    # ä¸Šæ¸¸æœåŠ¡å™¨
    upstream frontend {
        server frontend:3000;
    }

    upstream backend {
        server backend:8080;
    }

    # HTTP æœåŠ¡å™¨
    server {
        listen 80;
        server_name your-domain.com;

        # å‰ç«¯
        location / {
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }

        # åç«¯ API
        location /api {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # WebSocket
        location /ws {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # é™æ€èµ„æºç¼“å­˜
        location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
```

## ç¯å¢ƒå˜é‡ç®¡ç†

### .env æ–‡ä»¶

```bash
# æ•°æ®åº“é…ç½®
DB_ROOT_PASSWORD=rootpassword
DB_NAME=app_db
DB_USER=app_user
DB_PASSWORD=securepassword

# JWT é…ç½®
JWT_SECRET=your-super-secret-jwt-key

# åº”ç”¨é…ç½®
NODE_ENV=production
NEXT_PUBLIC_API_URL=https://api.your-domain.com
```

## å¸¸ç”¨å‘½ä»¤

### æ„å»ºå’Œå¯åŠ¨

```bash
# æ„å»ºæ‰€æœ‰æœåŠ¡
docker-compose build

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# åœæ­¢å¹¶åˆ é™¤å·
docker-compose down -v
```

### è°ƒè¯•å’Œç»´æŠ¤

```bash
# è¿›å…¥å®¹å™¨
docker-compose exec backend sh
docker-compose exec frontend sh

# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker-compose ps

# é‡å¯æœåŠ¡
docker-compose restart backend

# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats
```

## ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### 1. å®‰å…¨æ£€æŸ¥æ¸…å•

- âœ… ä½¿ç”¨é root ç”¨æˆ·è¿è¡Œå®¹å™¨
- âœ… å®šæœŸæ›´æ–°åŸºç¡€é•œåƒ
- âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿä¿¡æ¯
- âœ… å¯ç”¨ HTTPSï¼ˆLet's Encryptï¼‰
- âœ… é…ç½®é˜²ç«å¢™è§„åˆ™
- âœ… å®æ–½å¤‡ä»½ç­–ç•¥

### 2. æ€§èƒ½ä¼˜åŒ–

```dockerfile
# å‡å°é•œåƒå¤§å°
FROM alpine:latest

# ä½¿ç”¨æ„å»ºç¼“å­˜
COPY go.mod go.sum ./
RUN go mod download

# å¤šé˜¶æ®µæ„å»º
FROM builder AS final
```

### 3. å¥åº·æ£€æŸ¥

```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s
```

### 4. æ—¥å¿—ç®¡ç†

```yaml
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

## ç›‘æ§å’Œç»´æŠ¤

### 1. èµ„æºé™åˆ¶

```yaml
deploy:
  resources:
    limits:
      cpus: '0.5'
      memory: 512M
    reservations:
      cpus: '0.25'
      memory: 256M
```

### 2. è‡ªåŠ¨é‡å¯

```yaml
restart: unless-stopped
```

### 3. å¤‡ä»½ç­–ç•¥

```bash
# å¤‡ä»½æ•°æ®åº“
docker-compose exec db mysqldump -u root -p$DB_ROOT_PASSWORD $DB_NAME > backup.sql

# æ¢å¤æ•°æ®åº“
docker-compose exec -T db mysql -u root -p$DB_ROOT_PASSWORD $DB_NAME < backup.sql
```

## æ€»ç»“

Docker å®¹å™¨åŒ–éƒ¨ç½²æä¾›ï¼š

- ğŸš€ ä¸€è‡´çš„å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒ
- ğŸ“¦ ç®€åŒ–çš„éƒ¨ç½²æµç¨‹
- ğŸ”„ å¿«é€Ÿçš„å›æ»šèƒ½åŠ›
- ğŸ¯ èµ„æºéš”ç¦»å’Œé™åˆ¶
- ğŸ›¡ï¸ æå‡å®‰å…¨æ€§

æŒæ¡è¿™äº›æŠ€æœ¯ï¼Œä½ å°±èƒ½å®ç°ä¸“ä¸šçš„åº”ç”¨éƒ¨ç½²ï¼

